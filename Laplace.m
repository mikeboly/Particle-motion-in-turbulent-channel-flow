% 计算三维标量场 U(x, y, z) 的拉普拉斯算子

function LU = Laplace(x, y, z, U)
[Nx, Ny, Nz] = size(U);
LU = zeros(Nx, Ny, Nz);

% x方向的二阶导数
DU = U(2:Nx,:,:) - U(1:Nx-1,:,:);
LU(2:Nx-1,:,:) = LU(2:Nx-1,:,:) ...
    + 2*(DU(2:Nx-1,:,:)./(x(3:Nx) - x(2:Nx-1)) ...
    - DU(1:Nx-2,:,:)./(x(2:Nx-1) - x(1:Nx-2)))./(x(3:Nx) - x(1:Nx-2));
LU(1,:,:) = LU(1,:,:) + 2*(DU(2,:,:)/(x(3) - x(2)) ...
    - DU(1,:,:)/(x(2) - x(1)))/(-x(3) + 4*x(2) - 3*x(1));
LU(Nx,:,:) = LU(Nx,:,:) + 2*(DU(Nx-1,:,:)/(x(Nx) - x(Nx-1)) ...
    - DU(Nx-2,:,:)/(x(Nx-1) - x(Nx-2)))/(3*x(Nx) - 4*x(Nx-1) + x(Nx-2));

% y方向的二阶导数
DU = U(:,2:Ny,:) - U(:,1:Ny-1,:);
LU(:,2:Ny-1,:) = LU(:,2:Ny-1,:) ...
    + 2*(DU(:,2:Ny-1,:)./(y(3:Ny) - y(2:Ny-1))' ...
    - DU(:,1:Ny-2,:)./(y(2:Ny-1) - y(1:Ny-2))')./(y(3:Ny) - y(1:Ny-2))';
LU(:,1,:) = LU(:,1,:) + 2*(DU(:,2,:)/(y(3) - y(2)) ...
    - DU(:,1,:)/(y(2) - y(1)))/(-y(3) + 4*y(2) - 3*y(1));
LU(:,Ny,:) = LU(:,Ny,:) + 2*(DU(:,Ny-1,:)/(y(Ny) - y(Ny-1)) ...
    - DU(:,Ny-2,:)/(y(Ny-1) - y(Ny-2)))/(3*y(Ny) - 4*y(Ny-1) + y(Ny-2));

% z方向的二阶导数
DU = U(:,:,2:Nz) - U(:,:,1:Nz-1);
DU = permute(DU, [3 2 1]);
LU(:,:,2:Nz-1) = LU(:,:,2:Nz-1) ...
    + permute(2*(DU(2:Nz-1,:,:)./(z(3:Nz) - z(2:Nz-1)) ...
    - DU(1:Nz-2,:,:)./(z(2:Nz-1) - z(1:Nz-2))) ...
    ./(z(3:Nz) - z(1:Nz-2)), [3 2 1]);
DU = permute(DU, [3 2 1]);
LU(:,:,1) = LU(:,:,1) + 2*(DU(:,:,2)/(z(3) - z(2)) ...
    - DU(:,:,1)/(z(2) - z(1)))/(-z(3) + 4*z(2) - 3*z(1));
LU(:,:,Nz) = LU(:,:,Nz) + 2*(DU(:,:,Nz-1)/(z(Nz) - z(Nz-1)) ...
    - DU(:,:,Nz-2)/(z(Nz-1) - z(Nz-2)))/(3*z(Nz) - 4*z(Nz-1) + z(Nz-2));
end
